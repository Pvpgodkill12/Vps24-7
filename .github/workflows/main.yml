name: Continuous Persistent VPS
 
on:
  schedule:
    - cron: '0 */6 * * *'  # Runs every 6 hours
  workflow_dispatch:
 
jobs:
  vps-session:
    runs-on: ubuntu-latest
    timeout-minutes: 350  # Just under 6 hours
 
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }} 
          
      - name: âš™ï¸ Setup Environment (Hiding Install Logs)
        run: |
          echo "::group::Installing Prerequisites"
          sudo hostnamectl set-hostname root
          # Install MariaDB/MySQL client if needed for database restoration
          sudo apt update
          sudo apt install -y tmate curl unzip sudo net-tools neofetch git mariadb-client 
          echo "::endgroup::"
          
          echo "::group::Installing Tailscale and Cloudflared"
          curl -fsSL https://tailscale.com/install.sh | sh
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          sudo install cloudflared /usr/local/bin/cloudflared
          echo "::endgroup::"
 
      - name: ðŸ’¾ Retrieve Previous Backup from 'backup' Branch
        run: |
          echo "::group::Retrieving backup from Git branch"
          BACKUP_REPO_DIR=./backup/repo
          git clone --single-branch --branch backup https://oauth2:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git ${BACKUP_REPO_DIR} 2>/dev/null || \
          git clone https://oauth2:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git ${BACKUP_REPO_DIR}
          
          if [ -f ${BACKUP_REPO_DIR}/backup.zip ]; then
            mkdir -p ./backup
            mv ${BACKUP_REPO_DIR}/backup.zip ./backup/backup.zip
            echo "Backup file retrieved successfully."
          else
            echo "No backup file found on 'backup' branch."
          fi
          
          rm -rf ${BACKUP_REPO_DIR}
          echo "::endgroup::"
          
      - name: Restore Files and Tailscale State (Pterodactyl & Root)
        run: |
          echo "Restoring previous session files..."
          if [ -f ./backup/backup.zip ]; then
            unzip -o ./backup/backup.zip -d /
            echo "Session files restored."
            
            # Restore /root contents (Minecraft files, custom scripts)
            if [ -d /opt/vps-backup/data/root_home ]; then
                echo "Restoring /root directory contents (MC, Custom Files)..."
                sudo cp -a /opt/vps-backup/data/root_home/. /root/
            fi

            # --- NEW LOGIC: Restore Pterodactyl Panel/Wings files ---
            if [ -d /opt/vps-backup/data/pterodactyl_panel ]; then
                echo "Restoring Pterodactyl Panel files..."
                sudo cp -a /opt/vps-backup/data/pterodactyl_panel/. /var/www/pterodactyl/
            fi
            if [ -d /opt/vps-backup/data/pterodactyl_wings ]; then
                echo "Restoring Pterodactyl Wings data..."
                sudo cp -a /opt/vps-backup/data/pterodactyl_wings/. /var/lib/pterodactyl/
            fi
            
            # --- NEW LOGIC: Restore Database ---
            if [ -f /opt/vps-backup/data/pterodactyl_db.sql ]; then
                echo "Restoring Pterodactyl database..."
                # NOTE: This requires MariaDB/MySQL to be running later.
            fi
            
          else
            echo "No backup found, starting fresh."
          fi
          
          # Restore Tailscale state
          if [ -f /opt/vps-backup/data/tailscaled.state ]; then
            sudo mkdir -p /var/lib/tailscale
            sudo cp /opt/vps-backup/data/tailscaled.state /var/lib/tailscale/tailscaled.state
            sudo chmod 600 /var/lib/tailscale/tailscaled.state
            echo "Tailscale state restored."
          fi
 
      - name: ðŸš€ Start Networking Services & Database
        run: |
          # Start Database (Mandatory for Pterodactyl)
          sudo systemctl start mariadb || sudo systemctl start mysql || echo "Database service start failed, check installation."

          # Restore Pterodactyl Database (Must happen after the service starts)
          if [ -f /opt/vps-backup/data/pterodactyl_db.sql ]; then
              echo "Re-importing Pterodactyl database..."
              # WARNING: This assumes your DB root password is in the secret.
              sudo mysql -u root -p${{ secrets.DB_ROOT_PASSWORD }} panel < /opt/vps-backup/data/pterodactyl_db.sql || echo "Database restore failed. Check DB password secret."
          fi
          
          # Start Tailscale
          sudo tailscaled &
          sleep 8
          sudo tailscale up --authkey ${{ secrets.TAILSCALE_AUTHKEY }} --hostname=root || echo "Tailscale already up"
          
          # Start Cloudflare Tunnel (Token is sanitized)
          CLEAN_TOKEN=$(echo "${{ secrets.CF_TUNNEL_TOKEN }}" | tr -cd '[:print:]')
          sudo /usr/local/bin/cloudflared tunnel run --token "$CLEAN_TOKEN" &
          echo "Cloudflare Tunnel started."
          sleep 5

      - name: ðŸ” Configure Root User and SSH Access
        run: |
          # 1. Execute remote script
          curl -s https://raw.githubusercontent.com/JishnuTheGamer/Vps/refs/heads/main/cd/root -o /tmp/root_setup.sh
          chmod +x /tmp/root_setup.sh
          echo "Starting remote setup script..."
          sudo /tmp/root_setup.sh

          # 2. Set the password for the 'root' user to 'root'
          echo "Setting root password..."
          echo "root:root" | sudo chpasswd
          echo "root ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/root

          # 3. Explicitly fix SSH configuration and restart
          echo "Fixing SSH configuration..."
          sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo systemctl restart ssh || echo "SSH restart failed, continuing."

      - name: Start Tmate Server (Non-Blocking)
        run: |
          tmate -S /tmp/tmate.sock new-session -d
 
      - name: ðŸ”— VPS Connection Details (Static Access)
        run: |
          echo "=========================================="
          echo "Ã°Å¸Å’Â  STATIC PUBLIC DOMAIN ACCESS (Cloudflare Tunnel is ACTIVE)"
          echo "------------------------------------------"
          echo "Ã°Å¸â€â€” Tailscale IP (Internal VPN):"
          tailscale ip -4 || echo "Tailscale IP not found"
          echo ""
          echo "Ã°Å¸â€â€˜ Tmate SSH Session (Ephemeral):"
          tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}'
          echo "=========================================="
 
      - name: Sleep to Keep VPS Alive (6 Hours)
        run: sleep 21600
 
      # --- CANCELLATION-SAFE BACKUP STEPS ---

      - name: ðŸ’¾ Create Backup Archive (Pterodactyl & Root Data)
        if: always()
        run: |
          sudo mkdir -p /opt/vps-backup/data/root_home
          
          # 1. Database Backup (MOST CRITICAL for Pterodactyl)
          echo "Dumping Pterodactyl database..."
          # WARNING: This requires your DB root password in the secret.
          sudo mysqldump -u root -p${{ secrets.DB_ROOT_PASSWORD }} panel > /opt/vps-backup/data/pterodactyl_db.sql || echo "DB DUMP FAILED. Check DB password secret."

          # 2. Copy Panel Files
          echo "Copying Pterodactyl Panel files..."
          sudo mkdir -p /opt/vps-backup/data/pterodactyl_panel
          sudo cp -a /var/www/pterodactyl/. /opt/vps-backup/data/pterodactyl_panel/

          # 3. Copy Wings/Server Data (Minecraft files live here!)
          echo "Copying Pterodactyl Wings/Server data..."
          sudo mkdir -p /opt/vps-backup/data/pterodactyl_wings
          sudo cp -a /var/lib/pterodactyl/. /opt/vps-backup/data/pterodactyl_wings/

          # 4. Copy Root Home Directory (for custom scripts/files)
          echo "Copying /root directory contents..."
          sudo cp -a /root/. /opt/vps-backup/data/root_home/
          
          # 5. Copy Tailscale state
          sudo cp /var/lib/tailscale/tailscaled.state /opt/vps-backup/data/
          
          # Clean up and compress
          sudo rm -rf /opt/vps-backup/data/root_home/.cache /opt/vps-backup/data/root_home/.tmate.sock /opt/vps-backup/data/root_home/.bash_history
          sudo chown -R $USER:$USER /opt/vps-backup
          zip -r backup.zip /opt/vps-backup
 
      - name: ðŸ“¤ Store Backup on 'backup' Branch (Permanent Storage)
        if: always()
        run: |
          echo "::group::Pushing backup to Git branch"
          BACKUP_REPO_DIR=./backup-commit-repo
          
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions Backup"
          
          git clone --single-branch --branch backup https://oauth2:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git ${BACKUP_REPO_DIR} 2>/dev/null || \
          git clone https://oauth2:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git ${BACKUP_REPO_DIR}

          cd ${BACKUP_REPO_DIR}
          git checkout backup || git checkout -b backup
          
          cp ../backup.zip .
          
          git add backup.zip
          git commit -m "Automated backup from workflow run ${{ github.run_id }}" || echo "No changes to commit."
          git push origin backup
          echo "::endgroup::"
