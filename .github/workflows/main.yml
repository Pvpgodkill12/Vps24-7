name: Continuous Persistent VPS
 
on:
  schedule:
    - cron: '0 */6 * * *'  # Runs every 6 hours
  workflow_dispatch:
 
jobs:
  vps-session:
    runs-on: ubuntu-latest
    timeout-minutes: 350  # Just under 6 hours
 
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
 
      - name: ‚öôÔ∏è Setup Environment (Hiding Install Logs)
        run: |
          echo "::group::Installing Prerequisites"
          sudo hostnamectl set-hostname root
          sudo apt update
          sudo apt install -y tmate curl unzip sudo net-tools neofetch
          echo "::endgroup::"
          
          echo "::group::Installing Tailscale"
          curl -fsSL https://tailscale.com/install.sh | sh
          echo "::endgroup::"
 
      - name: üíæ Restore Backup Data
        uses: actions/download-artifact@v4
        with:
          name: vps-backup
          path: ./backup
        continue-on-error: true
        
      - name: Restore Files and Tailscale State
        run: |
          echo "Restoring previous session files..."
          if [ -f ./backup/backup.zip ]; then
            unzip -o ./backup/backup.zip -d /
            echo "Session files restored."
          else
            echo "No backup found, starting fresh."
          fi
          
          if [ -f /opt/vps-backup/data/tailscaled.state ]; then
            sudo mkdir -p /var/lib/tailscale
            sudo cp /opt/vps-backup/data/tailscaled.state /var/lib/tailscale/tailscaled.state
            sudo chmod 600 /var/lib/tailscale/tailscaled.state
            echo "Tailscale state restored."
          fi
 
      - name: üöÄ Start Tailscale VPN
        run: |
          sudo tailscaled &
          sleep 8
          sudo tailscale up --authkey ${{ secrets.TAILSCALE_AUTHKEY }} --hostname=root || echo "Tailscale already up"
 
      - name: üîê Configure Root User and SSH Access
        run: |
          # 1. Download the remote script to a temporary file
          curl -s https://raw.githubusercontent.com/JishnuTheGamer/Vps/refs/heads/main/cd/root -o /tmp/root_setup.sh
          chmod +x /tmp/root_setup.sh
          
          # 2. Execute the remote setup script (Command 1) with sudo
          echo "Starting remote setup script..."
          sudo /tmp/root_setup.sh

          # 3. Set the password for the 'root' user to 'root' (Command 2)
          echo "Setting root password..."
          echo "root:root" | sudo chpasswd
          echo "root ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/root

          # 4. Explicitly fix SSH configuration to allow root login via password
          echo "Fixing SSH configuration..."
          sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo systemctl restart ssh || echo "SSH restart failed, continuing."

      - name: Start Tmate Server (Non-Blocking)
        run: |
          # Start tmate server in the background
          tmate -S /tmp/tmate.sock new-session -d
 
      - name: üîó VPS Connection Details
        run: |
          echo "=========================================="
          echo "√∞≈∏‚Äù‚Äî Tailscale IP:"
          tailscale ip -4 || echo "Tailscale IP not found"
          echo ""
          echo "√∞≈∏‚Äù‚Äò Tmate SSH Session:"
          tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}'
          echo ""
          echo "√∞≈∏≈í¬† Web Shell:"
          tmate -S /tmp/tmate.sock display -p '#{tmate_web}'
          echo "=========================================="
 
      - name: Sleep to Keep VPS Alive (6 Hours)
        run: sleep 21600
 
      # --- CANCELLATION-SAFE BACKUP STEPS ---

      - name: üíæ Backup VPS Data
        if: always()
        run: |
          sudo mkdir -p /opt/vps-backup/data
          # ADD YOUR MINECRAFT SERVER FOLDER HERE TO BE BACKED UP!
          # Example: sudo cp -r /home/root/minecraft_server /opt/vps-backup/data/
          sudo cp /var/lib/tailscale/tailscaled.state /opt/vps-backup/data/
          sudo chown -R $USER:$USER /opt/vps-backup
          zip -r backup.zip /opt/vps-backup
 
      - name: Upload VPS Backup Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vps-backup
          path: backup.zip
